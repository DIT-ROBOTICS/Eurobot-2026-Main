<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
    
    <!-- ============================================= -->
    <!-- TAKE SubTree: Go to collection point and take -->
    <!-- ============================================= -->
    <BehaviorTree ID="TakeSubTree">
        <Sequence>
            <!-- Dock to collection pdoint -->
            <OnDockAction
                targetPoseIdx="{target_idx}"
                targetPoseSideIdx="{target_side}"
                targetDirection="{target_dir}"
                dock_type="dock_y_loose_linearBoost"
                isPureDocking="false"
                finish_pose="{dock_result}"/>
            
            <!-- Publish TAKE command to firmware -->
            <MissionPublisher
                ActionType="take"
                targetPoseSideIdx="{target_side}"
                targetPoseIdx="{target_idx}"/>
            <FieldUpdater/>

            <!-- Wait for vision to confirm take, or timeout -->
            <MissionChecker
                ActionType="take"
                targetPoseSideIdx="{target_side}"
                timeout_ms="3000"/>
            <!-- <Sleep msec="2000"/> -->
        </Sequence>
    </BehaviorTree>

    <!-- ============================================= -->
    <!-- FLIP SubTree: Flip the hazelnut               -->
    <!-- ============================================= -->
    <BehaviorTree ID="FlipSubTree">
        <Sequence>
            <!-- Publish FLIP command to firmware -->
            <MissionPublisher
                ActionType="flip"
                targetPoseSideIdx="{target_side}"
                targetPoseIdx="{target_idx}"/>

            <!-- Wait for flip to complete (pure timeout, no vision feedback) -->
            <MissionChecker
                ActionType="flip"
                targetPoseSideIdx="{target_side}"
                timeout_ms="1000"/>
        </Sequence>
    </BehaviorTree>
    
    <!-- ============================================= -->
    <!-- PUT SubTree: Go to pantry point and put -->
    <!-- ============================================= -->
    <BehaviorTree ID="PutSubTree">
        <Sequence>
            <!-- Flip and Dock in parallel: FlipPublisher waits for isDocking signal -->
            <Parallel success_count="2" failure_count="1">
                <OnDockAction
                    targetPoseIdx="{target_idx}"
                    targetPoseSideIdx="{target_side}"
                    targetDirection="{target_dir}"
                    dock_type="dock_y_loose_linearBoost"
                    isPureDocking="false"
                    finish_pose="{dock_result}"/>
                <FlipPublisher
                    targetPoseSideIdx="{target_side}"
                    timeout_ms="1000"/>
            </Parallel>
            
            <!-- Publish PUT command to firmware -->
            <MissionPublisher
                ActionType="put"
                targetPoseSideIdx="{target_side}"
                targetPoseIdx="{target_idx}"/>
            <FieldUpdater/>

            <!-- Wait for vision to confirm put, or timeout -->
            <MissionChecker
                ActionType="put"
                targetPoseSideIdx="{target_side}"
                timeout_ms="1500"/>
        </Sequence>
    </BehaviorTree>
    
    <!-- ============================================= -->
    <!-- Main Tree: Complete collection cycle -->
    <!-- Pattern: Fill all 4 robot sides, then empty them to pantries -->
    <!-- Repeat twice to handle all 8 collection points -->
    <!-- ============================================= -->
    <BehaviorTree ID="MainTree">
        <Sequence>
            <!-- Initialize receivers first -->
            <CamReceiver/>
            <LocReceiver/>
            <FieldUpdater/>         
            <Repeat num_cycles="1">
                <Sequence>
                    <DecisionCore 
                        ActionType="take"
                        RobotSideIdx="1"
                        nextActionType="{next_action}"
                        targetPoseIdx="{target_idx}"
                        targetPoseSideIdx="{target_side}"
                        targetDirection="{target_dir}"/>
                    <SubTree ID="TakeSubTree" _autoremap="true"/>
                    <DecisionCore 
                        ActionType="put"
                        RobotSideIdx="1"
                        nextActionType="{next_action}"
                        targetPoseIdx="{target_idx}"
                        targetPoseSideIdx="{target_side}"
                        targetDirection="{target_dir}"/>
                    <SubTree ID="PutSubTree" _autoremap="true"/>
                </Sequence>
            </Repeat>
            
        </Sequence>
    </BehaviorTree>
</root>
